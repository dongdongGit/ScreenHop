name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [x86_64-pc-windows-msvc, i686-pc-windows-msvc, aarch64-pc-windows-msvc]
        include:
          - target: x86_64-pc-windows-msvc
            arch: win-x64
          - target: i686-pc-windows-msvc
            arch: win-x86
          - target: aarch64-pc-windows-msvc
            arch: win-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Get version
        id: get_version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -like "refs/tags/*") {
            $version = $env:GITHUB_REF -replace "refs/tags/", ""
          } else {
            $version = "latest"
          }
          Write-Output "version=$version" >> $env:GITHUB_OUTPUT

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $ver = "${{ steps.get_version.outputs.version }}"
          $src = "target/${{ matrix.target }}/release/screenhop.exe"
          $dest = "ScreenHop-${{ matrix.arch }}-$ver.zip"
          Compress-Archive -Path $src -DestinationPath $dest

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: ScreenHop-*.zip

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [aarch64-apple-darwin, x86_64-apple-darwin]
        include:
          - target: aarch64-apple-darwin
            arch: macOS-arm64
          - target: x86_64-apple-darwin
            arch: macOS-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-bundle
        run: cargo install cargo-bundle

      - name: Build .app bundle
        working-directory: crates/app
        run: cargo bundle --release --target ${{ matrix.target }}

      - name: Ad-hoc code sign
        run: |
          codesign --force --deep --sign - \
            target/${{ matrix.target }}/release/bundle/osx/ScreenHop.app

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd target/${{ matrix.target }}/release/bundle/osx
          zip -r "$GITHUB_WORKSPACE/ScreenHop-${{ matrix.arch }}-$VERSION.zip" ScreenHop.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: ScreenHop-*.zip

  # åˆ›å»º macOS Universal .app Bundle
  build-macos-universal:
    runs-on: macos-latest
    needs: build-macos

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install cargo-bundle
        run: cargo install cargo-bundle

      - name: Build arm64 release
        working-directory: crates/app
        run: cargo bundle --release --target aarch64-apple-darwin

      - name: Build x86_64 release
        working-directory: crates/app
        run: cargo bundle --release --target x86_64-apple-darwin

      - name: Create Universal .app with lipo
        run: |
          # å¤åˆ¶ arm64 .app ä½œä¸ºåŸºç¡€
          cp -R target/aarch64-apple-darwin/release/bundle/osx/ScreenHop.app \
               target/ScreenHop-universal.app
          # ç”¨ lipo æ›¿æ¢å†…éƒ¨äºŒè¿›åˆ¶ä¸º Universal
          lipo -create \
            target/aarch64-apple-darwin/release/bundle/osx/ScreenHop.app/Contents/MacOS/screenhop \
            target/x86_64-apple-darwin/release/bundle/osx/ScreenHop.app/Contents/MacOS/screenhop \
            -output target/ScreenHop-universal.app/Contents/MacOS/screenhop
          # Ad-hoc ç­¾å
          codesign --force --deep --sign - target/ScreenHop-universal.app

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          cd target
          zip -r "$GITHUB_WORKSPACE/ScreenHop-macOS-universal-$VERSION.zip" ScreenHop-universal.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-macOS-universal
          path: ScreenHop-*.zip

  # å‘å¸ƒ Release
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-windows, build-macos-universal]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*.zip
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Window Mover ${{ steps.get_version.outputs.version }}

            ### ğŸ“¥ ä¸‹è½½é€‰æ‹© (Download Options)

            #### Windows
            - ğŸ’» **64ä½ (é€šç”¨)**: `ScreenHop-win-x64-....zip`
            - ğŸ–¥ï¸ **32ä½**: `ScreenHop-win-x86-....zip`
            - ğŸ“± **ARM64**: `ScreenHop-win-arm64-....zip`

            #### macOS
            - ğŸŒ **é€šç”¨ç‰ˆ (Universal)**: `ScreenHop-macOS-universal-....zip` âœ… æ¨è
            - ğŸ **Apple Silicon**: `ScreenHop-macOS-arm64-....zip`
            - ğŸ–¥ï¸ **Intel**: `ScreenHop-macOS-x86_64-....zip`

            ### ä½¿ç”¨æ–¹æ³•
            **Windows**: è§£å‹åè¿è¡Œ `screenhop.exe`
            **macOS**: è§£å‹åè¿è¡Œ `screenhop`ï¼Œé¦–æ¬¡éœ€åœ¨ **ç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ â†’ è¾…åŠ©åŠŸèƒ½** ä¸­æˆæƒ

            ---
            *Rust cross-platform build*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}